<!doctype html>
<html lang=en>
  <head>
    <meta charset=utf-8>
    <title>Social Media Tokens</title>
  </head>
  <body>
    <section>
      <h1>YouTube</h1>
      <dl>
        <dt>Client Id:</dt>
        <dd id="clientId"></dd>
        <dt>Client Secret:</dt>
        <dd id="clientSecret"></dd>
      </dl>
      <button id="btnGetCode">Get Offline Authorization Code</button>
      <dl>
        <dt>Code:</dt>
        <dd id="code"></dd>
        <dt>Scope:</dt>
        <dd id="scope"></dd>
      </dl>
      <button id="btnGetTokens">Get Tokens</button>
      <div>
        <label>Tokens:</label>
        <pre id="tokens"></pre>
      </div>
    </section>
    <section>
      <h1>Facebook</h1>
      <dl>
        <dt>App Id:</dt>
        <dd id="appId"></dd>
      </dl>
      <button id="btnGetFacebookCode">Get Authorization Code</button>
      <dl>
        <dt>Code:</dt>
        <dd id="facebookCode"></dd>
      </dl>
      <button id="btnGetFacebookToken">Get Token</button>
      <div>
        <label>Token:</label>
        <pre id="facebookToken"></pre>
      </div>
      <button id="btnExchangeToken">Exhange Token</button>
      <div>
        <label>Long-lived (Offline) Token:</label>
        <pre id="facebookLongToken"></pre>
      </div>
    </section>
    <script>
      (() => {
        const localServer = 'http://localhost:5000';
        const apiUri = 'https://www.googleapis.com/youtube/v3';
        const redirectEndpoint = '/redirect';
        const scope = 'https://www.googleapis.com/auth/youtube.upload';
        const facebookScope = 'ads_management';
        const facebookRedirect = '/fbredirect';

        let creds; 
        let code;
        let facebookCode;
        let facebookToken;

        let params = new URLSearchParams(window.location.search);

        if (params.has('code')) {
          let type = params.get('type');
          if (type == 'youtube') {
            code = params.get('code');
            document.getElementById('code').innerText = code;
            document.getElementById('scope').innerText = params.get('scope');

            document.getElementById('btnGetTokens').removeAttribute('disabled');
          } else if (type == 'facebook') {
            facebookCode = params.get('code');
            document.getElementById('facebookCode').innerText = facebookCode;

            document.getElementById('btnGetFacebookToken').removeAttribute('disabled');
          }  
        }

        fetch(`${localServer}/oauthCreds.json`)
            .then((oauth) => {
              return oauth.json();
            })
            .then((json) => {
              creds = json;

              document.getElementById('clientId').innerText = creds.client_id;
              document.getElementById('clientSecret').innerText = creds.client_secret;
              document.getElementById('appId').innerText = creds.app_id;
            });

        document.getElementById('btnGetCode').addEventListener('click', () => {
          let redirectUrl = `${localServer}${redirectEndpoint}`;
          let url = `${creds.auth_uri}?redirect_uri=${redirectUrl}&prompt=consent&response_type=code&client_id=${creds.client_id}&scope=${scope}&access_type=offline`;
          window.location = url;
        });

        document.getElementById('btnGetTokens').addEventListener('click', () => {
          fetch(`${creds.token_uri}`, {
            method: 'POST',
            body: `{
              "code": "${code}",
              "redirect_uri": "${localServer}${redirectEndpoint}",
              "client_id": "${creds.client_id}",
              "client_secret": "${creds.client_secret}",
              "grant_type": "authorization_code"
            }`
          })
          .then((response) => {
            document.getElementById('btnGetTokens').setAttribute('disabled', 'disabled');
            return response.json();
          })
          .then((json) => {
            document.getElementById('tokens').innerText = JSON.stringify(json, null, 3);
          });
        });

        document.getElementById('btnGetFacebookCode').addEventListener('click', () => {
          let redirectUrl = `${localServer}${facebookRedirect}`;
          let url = `${creds.facebook_auth_uri}?client_id=${creds.app_id}&redirect_uri=${redirectUrl}&scope=${facebookScope}`;
          window.location = url;
        });

        document.getElementById('btnGetFacebookToken').addEventListener('click', () => {
          let redirectUrl = `${localServer}${facebookRedirect}`
          fetch(`${creds.facebook_token_uri}?client_id=${creds.app_id}&redirect_uri=${redirectUrl}&client_secret=${creds.app_secret}&code=${facebookCode}`)
          .then((response) => {
            document.getElementById('btnGetFacebookToken').setAttribute('disabled', 'disabled');
            return response.json();
          })
          .then((json) => {
            facebookToken = json.access_token;
            document.getElementById('facebookToken').innerText = JSON.stringify(json, null, 3);
          });
        });

        document.getElementById('btnExchangeToken').addEventListener('click', () => {
          fetch(`${creds.facebook_token_uri}?client_id=${creds.app_id}&client_secret=${creds.app_secret}&grant_type=fb_exchange_token&fb_exchange_token=${facebookToken}`)
          .then((response) => {
            return response.json();
          })
          .then((json) => {
            document.getElementById('facebookLongToken').innerText = JSON.stringify(json, null, 3);
          });
        });
      })();
    </script>
  </body>
</html>